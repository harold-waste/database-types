{"version":3,"sources":["../../src/queries/getDatabaseTableColumns.js"],"names":["connection","schema","any","sql"],"mappings":";;;;;;AAEA;;;;;+BAQe,WAAOA,UAAP,EAA2CC,MAA3C,EAA+G;AAC5H,WAAOD,WAAWE,GAAX,CAAeC,aAAI;;;;;;;;;;;;;;;;;;;6BAmBCF,MAAO;;;;;;;;;;;;;;oFAcgDA,MAAO;;+BAE5DA,MAAO;GAnC7B,CAAP;AAqCD,G","file":"getDatabaseTableColumns.js","sourcesContent":["// @flow\n\nimport {\n  sql\n} from 'mightyql';\nimport type {\n  DatabaseConnectionType,\n  UnnormalizedColumnType\n} from '../types';\n\nexport default async (connection: DatabaseConnectionType, schema: string): Promise<$ReadOnlyArray<UnnormalizedColumnType>> => {\n  return connection.any(sql`\n    SELECT\n      col.table_name \"tableName\",\n      col.column_name \"columnName\",\n      col.is_nullable \"isNullable\",\n      col.data_type \"dataType\",\n      tco.constraint_type \"constraintType\",\n      pgc.\"constraintDef\"\n    FROM information_schema.columns col\n    left join (\n\t    select kcu.table_schema,\n\t       kcu.table_name,\n\t       kcu.column_name,\n\t       tco.constraint_type\n\t\tfrom information_schema.table_constraints tco\n\t\tjoin information_schema.key_column_usage kcu \n\t\t\t on kcu.constraint_name = tco.constraint_name\n\t\t\t and kcu.constraint_schema = tco.constraint_schema\n\t\t\t and kcu.constraint_name = tco.constraint_name\n\t\twhere kcu.table_schema = ${schema} and (tco.constraint_type = 'PRIMARY KEY' or tco.constraint_type = 'FOREIGN KEY')\n    ) as tco on tco.table_name = col.table_name and tco.column_name = col.column_name and tco.table_schema = col.table_schema\n    left join (\n\t\tselect pgc.conname as constraint_name,\n\t\t       ccu.table_schema as table_schema,\n\t\t       ccu.table_name,\n\t\t       ccu.column_name,\n\t\t       pg_get_constraintdef(pgc.oid) as \"constraintDef\"\n\t\tfrom pg_constraint pgc\n\t\tjoin pg_namespace nsp on nsp.oid = pgc.connamespace\n\t\tjoin pg_class  cls on pgc.conrelid = cls.oid\n\t\tleft join information_schema.constraint_column_usage ccu\n          on pgc.conname = ccu.constraint_name\n          and nsp.nspname = ccu.constraint_schema\n        where pg_get_constraintdef(pgc.oid) like '%ARRAY%' and ccu.table_schema = ${schema}\n    ) as pgc on pgc.table_name = col.table_name and pgc.column_name = col.column_name and pgc.table_schema = col.table_schema\n    WHERE col.table_schema = ${schema}\n  `);\n};\n"]}